STASH_NAME="pre-commit-$(date +%s)"
STASHED=false

has_unstaged_changes() {
  if ! git diff --quiet --ignore-submodules --; then
    return 0
  fi
  if [ -n "$(git ls-files --others --exclude-standard)" ]; then
    return 0
  fi
  return 1
}

if has_unstaged_changes; then
  echo "Stashing unstaged changes before running tests..."
  git stash push --keep-index --include-untracked -m "$STASH_NAME" >/dev/null 2>&1 || {
    echo "Failed to stash working tree changes. Aborting commit."
    exit 1
  }
  STASHED=true
fi

yarn test
TEST_RESULT=$?

if [ "$STASHED" = true ]; then
  echo "Restoring stashed changes..."
  if git stash list | grep -q "$STASH_NAME"; then
    git stash pop -q >/dev/null 2>&1 || {
      echo "Failed to reapply stashed changes. Please run 'git stash pop' manually."
      exit 1
    }
  fi
fi

exit $TEST_RESULT
