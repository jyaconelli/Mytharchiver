STASH_NAME="pre-commit-$(date +%s)"
STASHED=false
STASH_REF=""

cleanup() {
  if [ "$STASHED" = true ]; then
    echo "Restoring stashed changes..."
    if git rev-parse --verify "$STASH_REF" >/dev/null 2>&1; then
      if ! git stash pop -q "$STASH_REF" >/dev/null 2>&1; then
        echo "Failed to reapply stashed changes. Please run 'git stash pop' manually."
        exit 1
      fi
    fi
    STASHED=false
  fi
}

trap cleanup EXIT INT TERM

has_unstaged_changes() {
  if ! git diff --quiet --ignore-submodules --; then
    return 0
  fi
  if [ -n "$(git ls-files --others --exclude-standard)" ]; then
    return 0
  fi
  return 1
}

if has_unstaged_changes; then
  echo "Stashing unstaged changes before running tests..."
  git stash push --keep-index --include-untracked -m "$STASH_NAME" >/dev/null 2>&1 || {
    echo "Failed to stash working tree changes. Aborting commit."
    exit 1
  }
  STASH_REF=$(git stash list -n 1 --format='%gd')
  STASHED=true
fi

yarn test
TEST_RESULT=$?

exit $TEST_RESULT
